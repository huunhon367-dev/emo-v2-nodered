[{"id":"39c7b9d201e13984","type":"tab","label":"Flow 1","disabled":false,"info":"","env":[]},{"id":"b90fcafe891b0bae","type":"tab","label":"Flow 2","disabled":false,"info":"","env":[]},{"id":"1db59873d7b3b797","type":"tab","label":"Flow 3","disabled":false,"info":"","env":[]},{"id":"e3f4bf90846b83b2","type":"tab","label":"Flow 4","disabled":false,"info":"","env":[]},{"id":"ea36d04cc21903ad","type":"tab","label":"Flow 5","disabled":false,"info":"","env":[]},{"id":"1e6e63d4b953e192","type":"mqtt-broker","name":"","broker":"ca6ec9f256ab48b3854c2f609c0cb6af.s1.eu.hivemq.cloud","port":"8883","tls":"","clientid":"","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"9be5788e5c56aa2e","type":"ui_group","name":"C·∫£m X√∫c","tab":"60932ee10b58a2cd","order":1,"disp":true,"width":"6","collapse":false,"className":""},{"id":"60932ee10b58a2cd","type":"ui_tab","name":"ƒêi·ªÅu Khi·ªÉn Emo","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"0d8008ef312024a5","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"f4e920db46cff047","type":"ui_group","name":"D·∫´n ƒê∆∞·ªùng","tab":"60932ee10b58a2cd","order":2,"disp":true,"width":"6","collapse":false,"className":""},{"id":"469be2e8f3231664","type":"mqtt in","z":"39c7b9d201e13984","name":"Nh·∫≠n T·∫•t C·∫£ MQTT","topic":"emo/#","qos":"0","datatype":"auto-detect","broker":"1e6e63d4b953e192","nl":false,"rap":true,"rh":0,"inputs":0,"x":450,"y":860,"wires":[["6da7e5ca36d21f82"]]},{"id":"6da7e5ca36d21f82","type":"debug","z":"39c7b9d201e13984","name":"debug 1","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":640,"y":860,"wires":[]},{"id":"85f13d5d90dd20ec","type":"ui_button","z":"39c7b9d201e13984","name":"","group":"9be5788e5c56aa2e","order":0,"width":0,"height":0,"passthru":false,"label":"Bu·ªìn üò¢","tooltip":"","color":"m√†u xanh d∆∞∆°ng","bgcolor":"","className":"","icon":"","payload":"buon","payloadType":"str","topic":"topic","topicType":"msg","x":540,"y":1020,"wires":[["e050698614a9fb0f"]]},{"id":"e050698614a9fb0f","type":"ui_button","z":"39c7b9d201e13984","name":"","group":"9be5788e5c56aa2e","order":0,"width":0,"height":0,"passthru":false,"label":"Gi·∫≠n üò†","tooltip":"","color":"m√†u ƒë·ªè","bgcolor":"","className":"","icon":"","payload":"gian","payloadType":"str","topic":"topic","topicType":"msg","x":540,"y":1060,"wires":[["c69bad8dbe702efa"]]},{"id":"9b23ccc720b59cd6","type":"ui_button","z":"39c7b9d201e13984","name":"","group":"9be5788e5c56aa2e","order":0,"width":0,"height":0,"passthru":false,"label":"Vui üòä","tooltip":"","color":"xanh l√°","bgcolor":"","className":"","icon":"","payload":"vui","payloadType":"str","topic":"topic","topicType":"msg","x":530,"y":980,"wires":[["85f13d5d90dd20ec"]]},{"id":"c69bad8dbe702efa","type":"ui_button","z":"39c7b9d201e13984","name":"","group":"9be5788e5c56aa2e","order":0,"width":0,"height":0,"passthru":false,"label":"Ng·∫°c Nhi√™n üòÆ","tooltip":"","color":"m√†u v√†ng","bgcolor":"","className":"","icon":"","payload":"ngac_nhien","payloadType":"str","topic":"topic","topicType":"msg","x":560,"y":1100,"wires":[["a5a34ea8d52b06d2"]]},{"id":"7ab054de8614552f","type":"ui_button","z":"39c7b9d201e13984","name":"","group":"9be5788e5c56aa2e","order":0,"width":0,"height":0,"passthru":false,"label":"Ch·ªù üòê","tooltip":"","color":"m√†u x√°m","bgcolor":"","className":"","icon":"","payload":"cho","payloadType":"str","topic":"topic","topicType":"msg","x":540,"y":940,"wires":[["9b23ccc720b59cd6"]]},{"id":"a5a34ea8d52b06d2","type":"mqtt out","z":"39c7b9d201e13984","name":"G·ª≠i L·ªánh Emo","topic":"emo/lenh","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1e6e63d4b953e192","x":860,"y":860,"wires":[]},{"id":"b95399dd86dda2dd","type":"mqtt in","z":"b90fcafe891b0bae","name":"Nh·∫≠n Info ·∫¢nh","topic":"emo/camera/info","qos":"0","datatype":"auto-detect","broker":"1e6e63d4b953e192","nl":false,"rap":true,"rh":0,"inputs":0,"x":390,"y":120,"wires":[["49f8c1152dff80a9"]]},{"id":"153250545461ec26","type":"mqtt in","z":"b90fcafe891b0bae","name":"Nh·∫≠n Ho√†n Th√†nh","topic":"emo/camera/hoan_thanh","qos":"0","datatype":"auto-detect","broker":"1e6e63d4b953e192","nl":false,"rap":true,"rh":0,"inputs":0,"x":410,"y":200,"wires":[["49f8c1152dff80a9"]]},{"id":"1b8423ce031f6b48","type":"mqtt in","z":"b90fcafe891b0bae","name":"Nh·∫≠n G√≥i ·∫¢nh","topic":"emo/camera/goi","qos":"0","datatype":"auto-detect","broker":"1e6e63d4b953e192","nl":false,"rap":true,"rh":0,"inputs":0,"x":390,"y":160,"wires":[["49f8c1152dff80a9"]]},{"id":"49f8c1152dff80a9","type":"function","z":"b90fcafe891b0bae","name":"Gh√©p ·∫¢nh","func":"// Kh·ªüi t·∫°o bi·∫øn l∆∞u tr·ªØ\nvar cacGoiAnh = context.get('cacGoiAnh') || {};\nvar soGoiCanNhan = context.get('soGoiCanNhan') || 0;\n\nvar topic = msg.topic;\nvar payload = msg.payload;\n\n// Nh·∫≠n th√¥ng tin s·ªë g√≥i\nif (topic === \"emo/camera/info\") {\n    var info = JSON.parse(payload);\n    soGoiCanNhan = info.so_goi;\n    cacGoiAnh = {};\n    \n    context.set('soGoiCanNhan', soGoiCanNhan);\n    context.set('cacGoiAnh', cacGoiAnh);\n    \n    node.status({fill:\"blue\", shape:\"ring\", text:\"ƒêang nh·∫≠n \" + soGoiCanNhan + \" g√≥i...\"});\n    return null;\n}\n\n// Nh·∫≠n g√≥i ·∫£nh\nif (topic.startsWith(\"emo/camera/goi\")) {\n    var soGoi = parseInt(topic.replace(\"emo/camera/goi\", \"\"));\n    cacGoiAnh[soGoi] = payload;\n    context.set('cacGoiAnh', cacGoiAnh);\n    \n    var soGoiDaNhan = Object.keys(cacGoiAnh).length;\n    node.status({fill:\"yellow\", shape:\"dot\", text:\"ƒê√£ nh·∫≠n \" + soGoiDaNhan + \"/\" + soGoiCanNhan});\n    \n    return null;\n}\n\n// Ho√†n th√†nh - gh√©p ·∫£nh\nif (topic === \"emo/camera/hoan_thanh\") {\n    var anhDayDu = \"\";\n    for (var i = 0; i < soGoiCanNhan; i++) {\n        if (cacGoiAnh[i]) {\n            anhDayDu += cacGoiAnh[i];\n        }\n    }\n    \n    node.status({fill:\"green\", shape:\"dot\", text:\"Gh√©p ·∫£nh OK!\"});\n    \n    // Reset\n    context.set('cacGoiAnh', {});\n    context.set('soGoiCanNhan', 0);\n    \n    msg.payload = anhDayDu;\n    return msg;\n}\n\nreturn null;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":140,"wires":[["62b35d98fbc8a8df"]]},{"id":"62b35d98fbc8a8df","type":"function","z":"b90fcafe891b0bae","name":"T·∫°o Request Vision API","func":"var anhBase64 = msg.payload;\n\n// T·∫°o request cho Google Vision\nmsg.payload = {\n    \"requests\": [{\n        \"image\": {\n            \"content\": anhBase64\n        },\n        \"features\": [{\n            \"type\": \"FACE_DETECTION\",\n            \"maxResults\": 1\n        }]\n    }]\n};\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n};\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":240,"wires":[["788efd5f42960d46"]]},{"id":"788efd5f42960d46","type":"http request","z":"b90fcafe891b0bae","name":"Google Vision API","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://vision.googleapis.com/v1/images:annotate?key=AIzaSyBx0ZWphBGV0z706UbLDTfMmaMGVC4sRJs","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":670,"y":300,"wires":[["906275652dcbc289"]]},{"id":"906275652dcbc289","type":"function","z":"b90fcafe891b0bae","name":"Ph√¢n T√≠ch C·∫£m X√∫c","func":"var response = msg.payload;\n\n// Ki·ªÉm tra c√≥ khu√¥n m·∫∑t kh√¥ng\nif (response.responses && \n response.responses[0].faceAnnotations && \n response.responses[0].faceAnnotations.length > 0) {\n \n var face = response.responses[0].faceAnnotations[0];\n \n // L·∫•y c√°c c·∫£m x√∫c\nvar joy = face.joyLikelihood;\n var sorrow = face.sorrowLikelihood;\n var anger = face.angerLikelihood;\n var surprise = face.surpriseLikelihood;\n \n node.warn(\"C·∫£m x√∫c ph√°t hi·ªán:\");\n node.warn(\" Vui: \" + joy);\n node.warn(\" Bu·ªìn: \" + sorrow);\n node.warn(\" Gi·∫≠n: \" + anger);\n node.warn(\" Ng·∫°c nhi√™n: \" + surprise);\n \n // X√°c ƒë·ªãnh c·∫£m x√∫c ch√≠nh\n var camXuc = \"cho\";\n \n if (joy === \"VERY_LIKELY\" || joy === \"LIKELY\") {\n camXuc = \"vui\";\n } \n else if (sorrow === \"VERY_LIKELY\" || sorrow === \"LIKELY\") {\n camXuc = \"buon\";\n } \n else if (anger === \"VERY_LIKELY\" || anger === \"LIKELY\") {\n  camXuc = \"gian\";\n }\n else if (surprise === \"VERY_LIKELY\" || surprise === \"LIKELY\") {\n  camXuc = \"ngac_nhien\";\n }\n \n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n    // MODIFICATION 1: Ch·∫∑n l·ªánh \"cho\"\n    // N·∫øu camXuc v·∫´n l√† \"cho\" (t·ª©c l√† kh√¥ng c√≥ c·∫£m x√∫c n√†o ƒë·ªß m·∫°nh), th√¨ kh√¥ng g·ª≠i l·ªánh.\n    if (camXuc === \"cho\") {\n        node.status({fill:\"yellow\", shape:\"ring\", text:\"C·∫£m x√∫c y·∫øu/Ch·ªù (Gi·ªØ tr·∫°ng th√°i)\"});\n        return null; // <-- QUAN TR·ªåNG: D·ª´ng lu·ªìng, KH√îNG g·ª≠i tin nh·∫Øn MQTT.\n    }\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n \n node.status({fill:\"green\", shape:\"dot\", text:\"C·∫£m x√∫c: \" + camXuc});\n \n msg.payload = camXuc;\n msg.topic = \"emo/lenh\";\n \n return msg;\n \n} else {\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n    // MODIFICATION 2: Ch·∫∑n l·ªánh \"cho\" khi kh√¥ng c√≥ m·∫∑t\n    // Khi kh√¥ng c√≥ ng∆∞·ªùi, ta KH√îNG g·ª≠i l·ªánh \"cho\" n·ªØa.\n node.status({fill:\"grey\", shape:\"ring\", text:\"Kh√¥ng c√≥ ng∆∞·ªùi (Gi·ªØ tr·∫°ng th√°i)\"});\n \n return null; // <-- QUAN TR·ªåNG: D·ª´ng lu·ªìng, b·∫£o to√†n tr·∫°ng th√°i hi·ªán t·∫°i (c√≥ th·ªÉ l√† \"dem\").\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":360,"wires":[["d1ba3244f3dbc7e1"]]},{"id":"d1ba3244f3dbc7e1","type":"mqtt out","z":"b90fcafe891b0bae","name":"G·ª≠i L·ªánh Emo","topic":"emo/lenh","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1e6e63d4b953e192","x":640,"y":420,"wires":[]},{"id":"0db98e608eab7add","type":"http in","z":"1db59873d7b3b797","name":"Nh·∫≠n Th√¥ng B√°o Macrodroid","url":"/thong-bao","method":"post","upload":false,"swaggerDoc":"","x":420,"y":200,"wires":[["f12c77027f6cbdb1"]]},{"id":"f12c77027f6cbdb1","type":"function","z":"1db59873d7b3b797","name":"X·ª≠ L√Ω Th√¥ng B√°o Macrodroid","func":"var data = msg.payload;\n\nvar loai = data.loai || \"thong_bao\";\nvar ungDung = data.ung_dung || \"·ª®ng d·ª•ng\";\nvar tieuDe = data.tu || \"\";\nvar noiDung = data.noi_dung || \"\";\n\n// R√∫t g·ªçn t√™n ·ª©ng d·ª•ng\nvar tenNgan = ungDung;\nif (ungDung.includes(\"Telegram\")) tenNgan = \"Telegram\";\nif (ungDung.includes(\"Zalo\")) tenNgan = \"Zalo\";\nif (ungDung.includes(\"Messenger\")) tenNgan = \"Messenger\";\nif (ungDung.includes(\"Phone\") || ungDung.includes(\"Call\")) {\n    tenNgan = \"Cu·ªôc g·ªçi\";\n    loai = \"cuoc_goi\";\n}\nif (ungDung.includes(\"SMS\") || ungDung.includes(\"Messages\")) tenNgan = \"Tin nh·∫Øn\";\nif (ungDung.includes(\"Email\") || ungDung.includes(\"Gmail\")) tenNgan = \"Email\";\n\n// L·∫•y t√™n ng∆∞·ªùi g·ª≠i\nvar nguoiGui = tieuDe;\nif (nguoiGui.length > 15) {\n    nguoiGui = nguoiGui.substring(0, 12) + \"...\";\n}\n\n// T·∫°o JSON\nvar thongBao = {\n    \"loai\": loai,\n    \"tu\": nguoiGui || tenNgan,\n    \"noi_dung\": noiDung\n};\n\nmsg.payload = JSON.stringify(thongBao);\nmsg.topic = \"emo/thong_bao\";\n\nnode.warn(\"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\");\nnode.warn(\"Th√¥ng b√°o t·ª´: \" + tenNgan);\nnode.warn(\"Ti√™u ƒë·ªÅ: \" + tieuDe);\nnode.warn(\"N·ªôi dung: \" + noiDung);\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":200,"wires":[["4cbcd20f1408c027","d3e4a086b07c9721"]]},{"id":"4cbcd20f1408c027","type":"http response","z":"1db59873d7b3b797","name":"Tr·∫£ L·ªùi OK","statusCode":"200","headers":{},"x":970,"y":200,"wires":[]},{"id":"d3e4a086b07c9721","type":"mqtt out","z":"1db59873d7b3b797","name":"","topic":"emo/thong_bao","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1e6e63d4b953e192","x":980,"y":260,"wires":[]},{"id":"47dfe77b8a82da31","type":"ui_text_input","z":"e3f4bf90846b83b2","name":"Nh·∫≠p ƒêi·ªÉm ƒê·∫øn","label":"ƒêi·ªÉm ƒë·∫øn:","tooltip":"","group":"f4e920db46cff047","order":0,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"diem_den","sendOnBlur":true,"className":"","topicType":"msg","x":280,"y":180,"wires":[["9e48ed1b4a53d6ab"]]},{"id":"4d418140741764d5","type":"ui_button","z":"e3f4bf90846b83b2","name":"","group":"9be5788e5c56aa2e","order":5,"width":0,"height":0,"passthru":false,"label":"B·∫Øt ƒê·∫ßu D·∫´n ƒê∆∞·ªùng üöó","tooltip":"","color":"xanh l√°","bgcolor":"","className":"","icon":"","payload":"start","payloadType":"str","topic":"navigation","topicType":"msg","x":310,"y":220,"wires":[["9e48ed1b4a53d6ab"]]},{"id":"7679a64a89a25d41","type":"ui_button","z":"e3f4bf90846b83b2","name":"","group":"9be5788e5c56aa2e","order":5,"width":0,"height":0,"passthru":false,"label":"D·ª´ng D·∫´n ƒê∆∞·ªùng ‚èπÔ∏è","tooltip":"","color":"ƒë·ªè","bgcolor":"","className":"","icon":"","payload":"stop","payloadType":"str","topic":"navigation","topicType":"msg","x":300,"y":280,"wires":[["9e48ed1b4a53d6ab"]]},{"id":"9e48ed1b4a53d6ab","type":"function","z":"e3f4bf90846b83b2","name":"L·∫•y Ch·ªâ D·∫´n Google Maps","func":"// L·∫•y ƒëi·ªÉm ƒë·∫øn t·ª´ text input\nvar diemDen = flow.get(\"diem_den\") || \"\";\n\n// N·∫øu t·ª´ text input\nif (msg.topic === \"diem_den\") {\n    flow.set(\"diem_den\", msg.payload);\n    return null;\n}\n\n// N·∫øu t·ª´ button b·∫Øt ƒë·∫ßu\nif (msg.topic === \"navigation\" && msg.payload === \"start\") {\n    if (diemDen === \"\") {\n        node.error(\"Ch∆∞a nh·∫≠p ƒëi·ªÉm ƒë·∫øn!\");\n        return null;\n    }\n    \n    // ƒêi·ªÉm xu·∫•t ph√°t (c√≥ th·ªÉ l·∫•y t·ª´ GPS ƒëi·ªán tho·∫°i)\n    var diemXuatPhat = \"H√† N·ªôi\";  // Thay b·∫±ng v·ªã tr√≠ th·ª±c t·∫ø\n    \n    // Encode URL\n    var origin = encodeURIComponent(diemXuatPhat);\n    var destination = encodeURIComponent(diemDen);\n    \n    // API Key\n    var apiKey = \"API_KEY_CUA_BAN\";  // Thay b·∫±ng API Key\n    \n    // T·∫°o URL\n    msg.url = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destination}&mode=driving&language=vi&key=${apiKey}`;\n    \n    node.warn(\"L·∫•y ch·ªâ ƒë∆∞·ªùng: \" + diemXuatPhat + \" ‚Üí \" + diemDen);\n    \n    return msg;\n}\n\n// N·∫øu t·ª´ button d·ª´ng\nif (msg.topic === \"navigation\" && msg.payload === \"stop\") {\n    global.set(\"navigation_steps\", null);\n    global.set(\"current_step\", 0);\n    \n    msg.payload = \"cho\";\n    msg.topic = \"emo/lenh\";\n    \n    node.warn(\"ƒê√£ d·ª´ng d·∫´n ƒë∆∞·ªùng\");\n    \n    return msg;\n}\n\nreturn null;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":180,"wires":[["b9829baa374f9a3f"]]},{"id":"b9829baa374f9a3f","type":"http request","z":"e3f4bf90846b83b2","name":"Google Directions API","method":"GET","ret":"obj","paytoqs":"ignore","url":"{{url}}","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":580,"y":260,"wires":[["9b7d463a562872ee"]]},{"id":"9b7d463a562872ee","type":"function","z":"e3f4bf90846b83b2","name":"Ph√¢n T√≠ch Ch·ªâ D·∫´n","func":"var response = msg.payload;\n\n// Ki·ªÉm tra tr·∫°ng th√°i ph·∫£n h·ªìi\nif (!response || response.status !== \"OK\") {\n    node.error(\"Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng!\");\n    var thongBao = {\n        \"hanh_dong\": \"loi\",\n        \"chi_dan\": \"Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng\",\n        \"khoang_cach\": \"\"\n    };\n    msg.payload = JSON.stringify(thongBao);\n    msg.topic = \"emo/dan_duong\";\n    return msg;\n}\n\n// Ki·ªÉm tra c√≥ route hay kh√¥ng\nif (!response.routes || response.routes.length === 0) {\n    node.error(\"Kh√¥ng c√≥ route trong ph·∫£n h·ªìi API\");\n    return null;\n}\n\n// L·∫•y route v√† steps\nvar route = response.routes[0];\nif (!route.legs || route.legs.length === 0) {\n    node.error(\"Route kh√¥ng c√≥ legs\");\n    return null;\n}\n\nvar legs = route.legs[0];\nvar steps = legs.steps || [];\n\nnode.warn(\"T√¨m th·∫•y \" + steps.length + \" b∆∞·ªõc\");\n\n// L∆∞u c√°c b∆∞·ªõc v√†o bi·∫øn to√†n c·ª•c\nglobal.set(\"navigation_steps\", steps);\nglobal.set(\"current_step\", 0);\n\n// L·∫•y b∆∞·ªõc ƒë·∫ßu ti√™n\nif (steps.length === 0) {\n    node.error(\"Kh√¥ng c√≥ b∆∞·ªõc n√†o trong h∆∞·ªõng d·∫´n\");\n    return null;\n}\n\nvar firstStep = steps[0];\nvar chiDan = (firstStep.html_instructions || \"Kh√¥ng c√≥ h∆∞·ªõng d·∫´n\").replace(/<[^>]*>/g, '');\nvar khoangCach = firstStep.distance ? firstStep.distance.text : \"Kh√¥ng r√µ\";\n\n// G·ª≠i th√¥ng b√°o b·∫Øt ƒë·∫ßu\n thongBao = {\n    \"hanh_dong\": \"bat_dau\",\n    \"chi_dan\": chiDan,\n    \"khoang_cach\": khoangCach\n};\n\nmsg.payload = JSON.stringify(thongBao);\nmsg.topic = \"emo/dan_duong\";\n\nnode.warn(\"B∆∞·ªõc 1: \" + chiDan + \" - \" + khoangCach);\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":320,"wires":[["33cfd361f3629af7"]]},{"id":"33cfd361f3629af7","type":"mqtt out","z":"e3f4bf90846b83b2","name":"G·ª≠i D·∫´n ƒê∆∞·ªùng","topic":"emo/dan_duong","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1e6e63d4b953e192","x":560,"y":380,"wires":[]},{"id":"7ca3b4b25cc0e9dc","type":"inject","z":"ea36d04cc21903ad","name":"G·ª≠i B∆∞·ªõc Ti·∫øp Theo","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":400,"y":160,"wires":[["07ea754e285acb53"]]},{"id":"07ea754e285acb53","type":"function","z":"ea36d04cc21903ad","name":"L·∫•y B∆∞·ªõc Ti·∫øp Theo","func":"// L·∫•y c√°c b∆∞·ªõc ƒë√£ l∆∞u\nvar steps = global.get(\"navigation_steps\");\nvar currentIndex = global.get(\"current_step\");\n\n// N·∫øu kh√¥ng c√≥ d·∫´n ƒë∆∞·ªùng\nif (!steps || steps.length === 0) {\n    return null;\n}\n\n// TƒÉng index\ncurrentIndex++;\n\n// N·∫øu ƒë√£ h·∫øt\nif (currentIndex >= steps.length) {\n    node.warn(\"ƒê√£ ƒë·∫øn n∆°i!\");\n    \n    var thongBao = {\n        \"hanh_dong\": \"den_noi\"\n    };\n    \n    msg.payload = JSON.stringify(thongBao);\n    msg.topic = \"emo/dan_duong\";\n    \n    // Reset\n    global.set(\"navigation_steps\", null);\n    global.set(\"current_step\", 0);\n    \n    return msg;\n}\n\n// L·∫•y b∆∞·ªõc ti·∫øp theo\nvar step = steps[currentIndex];\nvar chiDan = step.html_instructions.replace(/<[^>]*>/g, '');\nvar khoangCach = step.distance.text;\n\nglobal.set(\"current_step\", currentIndex);\n\n thongBao = {\n    \"hanh_dong\": \"buoc\",\n    \"chi_dan\": chiDan,\n    \"khoang_cach\": khoangCach\n};\n\nmsg.payload = JSON.stringify(thongBao);\nmsg.topic = \"emo/dan_duong\";\n\nnode.warn(\"B∆∞·ªõc \" + (currentIndex + 1) + \": \" + chiDan + \" - \" + khoangCach);\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":160,"wires":[["865560ee1d7b3498"]]},{"id":"865560ee1d7b3498","type":"mqtt out","z":"ea36d04cc21903ad","name":"G·ª≠i D·∫´n ƒê∆∞·ªùng","topic":"emo/dan_duong","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1e6e63d4b953e192","x":900,"y":160,"wires":[]}]